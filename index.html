<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background: #000; text-align: center; }
#color { width: 350px; margin: 1em auto; }
#hex { width: 350px; margin: 1em auto; color: #fff; font: 4em monospace; }
#offset { width: 100px; margin: 1em auto; }
</style>
<title>Globe</title>
<body>

<div id="color"></div>
<div id="hex"></div>
<button id="now"></button>

<script src="/iro.js"></script>
<script>
var now = null;
var offset = 0;

document.getElementById("now").click = () => {
  const xhr = new XMLHttpRequest();
  xhr.open("POST", "/state");
  xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhr.send("offset=" + 1);
};

const picker = new iro.ColorPicker("#color", {
  width: 320,
  height: 320,
  color: {r: 0, g: 0, b: 0},
  borderWidth: 1,
  borderColor: "#fff",
});

picker.on("color:change", (() => {
  let timeout;
  return color => {
    if (!timeout) {
      timeout = setTimeout(() => { timeout = null; }, wait);
      const hex = color.hexString;
      document.getElementById("hex").innerHTML = hex;
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/state");
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send("color=" + hex);
    }
  };
})());

setInterval(() => {
const xhr = new XMLHttpRequest();
  xhr.responseType = "json";
  xhr.open("GET", "/state");
  xhr.onload = () => {
    console.log(xhr);
    const json = xhr.response;
    now = json.now;
    offset = json.offset;
    picker.color.rgb = iro.Color.parseHexStr("#" + json.color.slice(0, 6));
    document.getElementById("now").innerHTML =
      new Date(new Date().getTime() + 1000 * offset).toTimeString();
  };
  xhr.send();
}, 10000);
</script>
